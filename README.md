# ç”¨æˆ·é•¿æœŸå…´è¶£å»ºæ¨¡

æœ¬ä»“åº“å®ç°äº†ä¸€ä¸ªåŸºäº Transformerçš„ç”¨æˆ·é•¿æœŸå…´è¶£ç¦»çº¿è¡¨å¾æ¨¡å‹ã€‚

---

## ğŸ“‹ ç›®å½•

- [èƒŒæ™¯](#èƒŒæ™¯)
- [æ•°æ®](#æ•°æ®)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [ç¯å¢ƒä¸ä¾èµ–](#ç¯å¢ƒä¸ä¾èµ–)
- [è®¾ç½®ä¸æ•°æ®é¢„å¤„ç†](#è®¾ç½®ä¸æ•°æ®é¢„å¤„ç†)
- [æ¨¡å‹æ¶æ„](#æ¨¡å‹æ¶æ„)
- [è®­ç»ƒ](#è®­ç»ƒ)
- [æ¨ç†ä¸ Redis é›†æˆ](#æ¨ç†ä¸-redis-é›†æˆ)
- [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
- [é…ç½®](#é…ç½®)
- [è®¸å¯è¯](#è®¸å¯è¯)

---

## èƒŒæ™¯

åœ¨å¤§è§„æ¨¡æ¨èç³»ç»Ÿä¸­ï¼ŒåŒæ—¶æ•æ‰ç”¨æˆ·çš„é•¿æœŸåå¥½å’Œè¿‘æœŸå…´è¶£å¯¹äºæé«˜æ¨èå‡†ç¡®æ€§è‡³å…³é‡è¦ã€‚åœ¨çº¿å¯¹ç”¨æˆ·è¡Œä¸ºåºåˆ—è¿›è¡Œå‘é‡è¡¨å¾ï¼Œæœ‰ä»¥ä¸‹çš„é—®é¢˜ï¼šaverage poolçš„æ–¹æ³•ä½æ•ˆï¼›ä½¿ç”¨åŒå±‚attentionçš„DINæ¨¡å‹å—é™äºåºåˆ—é•¿åº¦ï¼›DIENæ¨¡å‹ä¸ºGRUéšè—çŠ¶æ€åŠ å…¥è¾…åŠ©æŸå¤±å‡½æ•°ä¼šå¢åŠ é¡¹ç›®éƒ¨ç½²éš¾åº¦ï¼›SIMæ¨¡å‹é€šè¿‡hard/soft searchç­–ç•¥æ’é™¤ä½ç›¸å…³è¡Œä¸ºåºåˆ—ï¼Œä¼šä¸¢å¤±éƒ¨åˆ†æœ‰ç”¨ä¿¡æ¯ã€‚è€Œé€šè¿‡ç¦»çº¿è®¡ç®—ç”¨æˆ·é•¿æœŸå…´è¶£çš„å‘é‡è¡¨å¾ï¼Œç¼“å­˜èµ·æ¥ä¾›åœ¨çº¿æ¨¡å‹ç´¢å¼•ï¼Œå¯å…¼é¡¾å¼€é”€ä¸æ€§èƒ½ã€‚æœ¬é¡¹ç›®å®ç°äº†ä¸€ä¸ªåŸºäº Transformer çš„ç”¨æˆ·é•¿æœŸå…´è¶£ç¦»çº¿è¡¨å¾æ¨¡å‹ï¼ŒåŒ…æ‹¬ï¼š

1. **é•¿æœŸå¡”**ï¼šç¼–ç ç”¨æˆ·å†å²äº¤äº’åºåˆ—ï¼Œè¾“å‡ºè¡¨ç¤ºé•¿æœŸå…´è¶£çš„embedding
2. **çŸ­æœŸå¡”**ï¼šé‡‡ç”¨ä¸é•¿æœŸå¡”ç›¸åŒçš„ç»“æ„ï¼ˆç›¸åŒç»´åº¦çš„Embeddingè¾“å‡ºï¼‰ã€‚
3. **è¡¨å¾è¾“å‡º**ï¼šä½¿ç”¨ Transformer çš„ `[CLS]` Token ä½ç½®å¯¹åº”çš„å‘é‡ä½œä¸ºæœ€ç»ˆç”¨æˆ·å…´è¶£è¡¨å¾ï¼ˆæ›¿æ¢åŸå…ˆçš„ mean poolingï¼‰ã€‚
4. **ä¼˜åŒ–ç›®æ ‡**ï¼šé€šè¿‡ BPR loss æ„é€ ä¸‰å…ƒç»„ï¼ˆåŒä¸€ç”¨æˆ·çš„é•¿/çŸ­æœŸåºåˆ— + è´Ÿæ ·æœ¬çŸ­æœŸåºåˆ—ï¼‰ï¼Œæœ€å¤§åŒ–åŒä¸€ç”¨æˆ·é•¿çŸ­æœŸå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼Œæœ€å°åŒ–ä¸è´Ÿæ ·æœ¬çš„ç›¸ä¼¼åº¦ã€‚

---

## æ•°æ®

- **æ•°æ®é›†**ï¼šé˜¿é‡Œäº‘å¤©æ± ç§»åŠ¨æ¨èç®—æ³•å…¬å¼€æ•°æ®é›†
- **ä¸‹è½½**ï¼šhttps://tianchi.aliyun.com/dataset/46
- **åŸå§‹æ–‡ä»¶**ï¼š
  - `tianchi_mobile_recommend_train_user.csv`
- **å­—æ®µè¯´æ˜**ï¼š
  - `user_id`ï¼šè„±æ•ç”¨æˆ· ID
  - `item_id`ï¼šè„±æ•å•†å“ ID
  - `behavior_type`ï¼šè¡Œä¸ºç±»å‹ï¼ˆ1=æµè§ˆï¼Œ2=æ”¶è—ï¼Œ3=åŠ è´­ï¼Œ4=è´­ä¹°ï¼‰
  - `user_geohash`ï¼šåœ°ç†ä½ç½®ç¼–ç ï¼ˆå¯ç©ºï¼‰
  - `item_category`ï¼šå•†å“ç±»åˆ«
  - `time`ï¼šè¡Œä¸ºæ—¶é—´ï¼ˆå°æ—¶çº§ç²¾åº¦ï¼‰
- **æ—¶é—´èŒƒå›´**ï¼š2014â€‘11â€‘18 è‡³ 2014â€‘12â€‘18ï¼Œç”¨äºé¢„æµ‹ 2014â€‘12â€‘19 çš„è´­ä¹°ã€‚

---

## ç›®å½•ç»“æ„

```
â”œâ”€â”€ DATA/               
â”‚   â””â”€â”€ train_user/           # åŸå§‹ CSV æ•°æ®
â”œâ”€â”€ saved_models/         
â”‚   â”œâ”€â”€ feature_embedding.pth # ç‰¹å¾åµŒå…¥å±‚æƒé‡
â”‚   â”œâ”€â”€ long_term.pth         # é•¿æœŸå¡”æ¨¡å‹æƒé‡
â”‚   â”œâ”€â”€ short_term.pth        # çŸ­æœŸå¡”æ¨¡å‹æƒé‡
â”‚   â””â”€â”€ moe_layer.pth         # MoEå±‚æ¨¡å‹æƒé‡
â”œâ”€â”€ train.py                  # ç«¯åˆ°ç«¯è®­ç»ƒ & Redis å¯¼å‡ºè„šæœ¬
â”œâ”€â”€ LongTermInterestModel.py  # åŒå¡” Transformer æ¨¡å‹å®šä¹‰
â”œâ”€â”€ DeepSeekMoE.py            # å¸¦è´Ÿè½½å‡è¡¡çš„æ··åˆä¸“å®¶ç½‘ç»œå®ç°
â”œâ”€â”€ requirements.txt          # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md                 # æœ¬æ–‡ä»¶
```

---

## ç¯å¢ƒä¸ä¾èµ–

- **Python**ï¼š3.8+
- **PyTorch**ï¼š1.9+ï¼ˆæ¨è 1.10ï¼‰
- **CUDA**ï¼š11.1+ï¼ˆè‹¥ä½¿ç”¨ GPUï¼‰
- **å…¶å®ƒ**ï¼š
  - pandas
  - numpy
  - scikit-learn
  - tqdm
  - redis-py

å®‰è£…ä¾èµ–ï¼š

```bash
pip install -r requirements.txt
```

---

## è®¾ç½®ä¸æ•°æ®é¢„å¤„ç†

1. **ä¸‹è½½å¹¶è§£å‹**
   å°† `tianchi_mobile_recommend_train_user.csv` æ”¾å…¥ `DATA/train_user/`ã€‚
2. **Label Encode**
   å°† `user_id`ã€`item_id` æ˜ å°„ä¸ºè¿ç»­æ•´æ•°ç´¢å¼•ï¼Œä¿ç•™ `0` ä½œä¸º paddingã€‚
3. **åºåˆ—åˆ‡åˆ†**
   - æŒ‰æ—¶é—´å‡åºæ’åº
   - å‰ 90% äº¤äº’æ„æˆé•¿æœŸåºåˆ—ï¼›å 10% æ„æˆçŸ­æœŸåºåˆ—
4. **Padding**
   - é•¿æœŸåºåˆ—é•¿åº¦ä¸‹é™ `N_MIN=100`
   - çŸ­æœŸåºåˆ—é•¿åº¦ä¸‹é™ `K_MIN=10`
5. **ç‰¹å¾æå–**
   - å•†å“IDç¼–ç 
   - å•†å“ç±»åˆ«ç¼–ç 
   - æ—¶é—´ç‰¹å¾ï¼šæ˜ŸæœŸã€å°æ—¶ã€å‘¨æœ«æ ‡è®°
   - æ—¶é—´æˆ³å½’ä¸€åŒ–ï¼šè·ç¦»å¼€å§‹å’Œç»“æŸçš„ç›¸å¯¹æ—¶é—´
   - è¡Œä¸ºç±»å‹ç¼–ç 

ä¸Šè¿°é€»è¾‘å·²åœ¨ `scripts/train.py` ä¸­å®ç°ã€‚

---

## æ¨¡å‹æ¶æ„

- **ç‰¹å¾åµŒå…¥å±‚**ï¼š
  - å•†å“åµŒå…¥ `nn.Embedding(num_items, ITEM_EMBEDDING_DIM)`
  - ç±»åˆ«åµŒå…¥ `nn.Embedding(num_categories, CATE_EMBEDDING_DIM)`
  - æ—¶é—´ç‰¹å¾åµŒå…¥ï¼ˆæ˜ŸæœŸã€å°æ—¶ã€å‘¨æœ«ï¼‰
  - è¡Œä¸ºç±»å‹åµŒå…¥
  - è¿ç»­ç‰¹å¾æŠ•å½±
- **åŒå¡” Transformer**ï¼š
  - **å±‚æ•°**ï¼š configurable, é»˜è®¤ 4 å±‚
  - **å¤šå¤´è‡ªæ³¨æ„åŠ›**ï¼š8å¤´æ³¨æ„åŠ›æœºåˆ¶
  - **å¤´ç»´åº¦**ï¼š64ç»´
- **MoE å±‚ï¼ˆDeepSeekV3ç‰ˆæœ¬ï¼‰**ï¼š
  - **ä¸“å®¶æ•°é‡**ï¼šå¯é…ç½®ï¼Œé»˜è®¤ 100 ä¸ªè·¯ç”±ä¸“å®¶ + 1 ä¸ªå…±äº«ä¸“å®¶
  - **æ¿€æ´»ä¸“å®¶æ•°**ï¼šæ¯ä¸ªtokenä»…æ¿€æ´»å°‘é‡ä¸“å®¶(top-k)ï¼Œé»˜è®¤ k=2
  - **ä¸“å®¶ç»“æ„**ï¼šåŒ…å«layernormã€SwiGLUæ¿€æ´»å’Œdropoutçš„å‰é¦ˆç½‘ç»œ
  - **é—¨æ§æœºåˆ¶**ï¼šä½¿ç”¨çº¿æ€§å±‚+sigmoidå®ç°çš„é—¨æ§ç½‘ç»œ
  - **è´Ÿè½½å‡è¡¡**ï¼š
    - æ¯ä¸ªè®­ç»ƒepochç»Ÿè®¡ä¸“å®¶æ¿€æ´»æ¬¡æ•°
    - è®¡ç®—ä¸“å®¶æ¿€æ´»ç™¾åˆ†æ¯”
    - åœ¨è·¯ç”±é€‰æ‹©æ—¶å¯¹é«˜ä½¿ç”¨ç‡ä¸“å®¶è¿›è¡Œæƒ©ç½šï¼ˆé™¤ä»¥æ¿€æ´»ç™¾åˆ†æ¯”ï¼‰
- **è¾“å‡ºè¡¨å¾**ï¼šå– Transformer è¾“å‡ºï¼Œç»´åº¦ `HIDDEN_DIM=128`

---

## è®­ç»ƒ

```bash
python scripts/train.py \
  --data_path DATA/train_user \
  --save_dir saved_models \
  --epochs 5 \            
  --batch_size 256 \
  --lr 1e-3
```

- **è´Ÿè½½å‡è¡¡æµç¨‹**ï¼š
  1. æ¯ä¸ªepochå¼€å§‹æ—¶é‡ç½®ä¸“å®¶æ¿€æ´»è®¡æ•°
  2. è®­ç»ƒè¿‡ç¨‹ä¸­ç´¯è®¡è®°å½•ä¸“å®¶æ¿€æ´»æ¬¡æ•°
  3. æ¯ä¸ªepochç»“æŸæ—¶è®¡ç®—å„ä¸“å®¶æ¿€æ´»ç™¾åˆ†æ¯”
  4. ä¸‹ä¸€ä¸ªepochä½¿ç”¨è¿™äº›ç™¾åˆ†æ¯”è°ƒæ•´è·¯ç”±é€‰æ‹©
  5. è¾“å‡ºä¸“å®¶ä½¿ç”¨åˆ†å¸ƒï¼Œç”¨äºç›‘æ§å‡è¡¡æ•ˆæœ
- **æŸå¤±**ï¼šBPR lossï¼ˆä¸‰å…ƒç»„ï¼‰
- **ä¼˜åŒ–å™¨**ï¼šAdam
- **å­¦ä¹ ç‡**ï¼šå›ºå®š 1e-3
- **ç›‘æ§æŒ‡æ ‡**ï¼šå¹³å‡ BPR loss å’Œä¸“å®¶ä½¿ç”¨åˆ†å¸ƒ

---

## æ¨ç†ä¸ Redis é›†æˆ

1. åŠ è½½æ‰€æœ‰æ¨¡å‹æƒé‡ï¼š
   ```python
   feature_embedding.load_state_dict(torch.load('saved_models/feature_embedding.pth'))
   model_long.load_state_dict(torch.load('saved_models/long_term.pth'))
   moe_layer.load_state_dict(torch.load('saved_models/moe_layer.pth'))
   model_long.eval()
   feature_embedding.eval()
   moe_layer.eval()
   ```
2. æ„é€ å…¨åºåˆ—ï¼ˆpad/trunc è‡³ `N_MAX`ï¼‰ï¼Œé€šè¿‡æ¨¡å‹è®¡ç®—å‘é‡ï¼š
   ```python
   # ç‰¹å¾åµŒå…¥
   seq_emb = feature_embedding(features)
   # é€šè¿‡MoEå±‚
   seq_emb = moe_layer(seq_emb)
   # è·å–é•¿æœŸå…´è¶£å‘é‡
   u_emb = model_long(seq_emb).cpu().tolist()
   ```
3. å°†è„±æ•åçš„ `user_id` åç¼–ç ä¸ºåŸå§‹ IDï¼ŒJSON åºåˆ—åŒ–åå†™å…¥ Redisï¼š
   ```python
   import redis, json
   r = redis.Redis(host='localhost', port=6379, db=0)
   r.set(raw_user_id, json.dumps(u_emb))
   ```

---

## ä½¿ç”¨ç¤ºä¾‹

```bash
# è®­ç»ƒå¹¶å¯¼å‡ºè‡³ Redis
python scripts/train.py --data_path DATA/train_user --save_dir saved_models

# åœ¨çº¿è¯»å–ç”¨æˆ·é•¿æœŸå‘é‡
>>> import redis, json
>>> r = redis.Redis()
>>> vec = json.loads(r.get('user_1234'))
>>> # vec å³è¯¥ç”¨æˆ·çš„ 128 ç»´é•¿æœŸå…´è¶£å‘é‡
```

---

## é…ç½®

æ‰€æœ‰è¶…å‚å‡å¯åœ¨ `scripts/train.py` é¡¶éƒ¨ä¿®æ”¹ï¼Œæˆ–é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¦†ç›–ï¼š

- **æ•°æ®ç›¸å…³**
  - `--data_path`
  - `--save_dir`
- **è®­ç»ƒç›¸å…³**
  - `--batch_size`
  - `--epochs`
  - `--lr`
- **æ¨¡å‹ç›¸å…³**
  - `--item_embedding_dim`
  - `--hidden_dim`
  - `--depth`
  - `--heads`
- **MoEç›¸å…³**
  - `--moe_experts`: ä¸“å®¶æ•°é‡
  - `--moe_activated`: æ¿€æ´»ä¸“å®¶æ•°
  - `--moe_hidden`: ä¸“å®¶éšè—å±‚ç»´åº¦

---

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ [LICENSE](LICENSE)ã€‚

---
